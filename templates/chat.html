{% extends "base.html" %}
{% block content %}
  <div class="chat-wrapper">
      <div class="chat-history" id="chatHistory">
          {% if has_more %}
            <div class="load-more" id="loadMoreContainer">
                <a href="#" id="loadMoreBtn" data-limit="{{ limit }}">åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯</a>
            </div>
          {% endif %}

          {% for msg in messages %}
            <div class="message {% if msg.is_bot %}bot{% else %}user{% endif %}" data-message-id="{{ msg.id }}">
                <div class="message-avatar">
                    {% if msg.is_bot %}ğŸ‘¨â€âš•ï¸{% else %}ğŸ‘¤{% endif %}
                </div>
                <div class="message-content">
                      <div class="bubble">{{ msg.content | replace('\n', '<br>') | safe }}</div>
                      <div class="meta">
                         <span>{{ msg.created_at | china_time }}</span>
                         <button type="button" class="delete-btn" data-message-id="{{ msg.id }}">åˆ é™¤</button>
                      </div>
                </div>
            </div>
          {% endfor %}
      </div>

      <form class="input-area" id="messageForm">
          <textarea id="messageInput" name="message" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯... (Shift+Enteræ¢è¡Œï¼ŒEnterå‘é€)" required></textarea>
          <button type="submit" class="btn btn-primary" id="sendBtn">å‘é€</button>
      </form>
  </div>

  <script>
      const chatHistory = document.getElementById('chatHistory');
      const messageForm = document.getElementById('messageForm');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');

      // HTMLè½¬ä¹‰å‡½æ•°
      function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
      }

      // æ ¼å¼åŒ–æ–‡æœ¬ï¼Œå°†æ¢è¡Œè½¬æ¢ä¸º<br>ï¼ŒåŒæ—¶è½¬ä¹‰HTML
      function formatText(text) {
          return escapeHtml(text).replace(/\n/g, '<br>');
      }

      // æ»šåŠ¨åˆ°åº•éƒ¨çš„è¾…åŠ©å‡½æ•°
      function scrollToBottom() {
          // å¼ºåˆ¶æµè§ˆå™¨é‡æ–°è®¡ç®—å¸ƒå±€
          const forceReflow = function() {
              chatHistory.style.overflow = 'hidden';
              chatHistory.offsetHeight; // å¼ºåˆ¶é‡æ’
              chatHistory.style.overflow = 'auto';
          };
          
          const scroll = function() {
              // å…ˆå¼ºåˆ¶é‡æ’
              forceReflow();
              
              // ç›´æ¥è®¾ç½®scrollTopä¸ºæœ€å¤§å€¼
              chatHistory.scrollTop = chatHistory.scrollHeight;
              
              // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨scrollIntoView
              const lastChild = chatHistory.lastElementChild;
              if (lastChild && lastChild.scrollIntoView) {
                  try {
                      lastChild.scrollIntoView({ behavior: 'auto', block: 'end', inline: 'nearest' });
                  } catch(e) {
                      // å¦‚æœscrollIntoViewå¤±è´¥ï¼Œå¿½ç•¥é”™è¯¯
                  }
              }
          };
          
          // ç«‹å³å°è¯•æ»šåŠ¨
          scroll();
          
          // ä½¿ç”¨requestAnimationFrameç¡®ä¿DOMå·²æ›´æ–°
          requestAnimationFrame(function() {
              scroll();
              // å»¶è¿Ÿç¡®ä¿å†…å®¹å®Œå…¨æ¸²æŸ“ï¼ˆç‰¹åˆ«æ˜¯å›¾ç‰‡ã€å­—ä½“ç­‰åŠ è½½åï¼‰
              setTimeout(scroll, 50);
              setTimeout(scroll, 150);
          });
      }

      // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å†å²
      function addMessage(message, isBot) {
          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${isBot ? 'bot' : 'user'}`;
          messageDiv.setAttribute('data-message-id', message.id);
          
          // ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„æ—¶é—´æ ¼å¼ï¼Œæˆ–æ ¼å¼åŒ–å½“å‰æ—¶é—´
          const timeStr = message.created_at || new Date().toISOString().slice(0, 16).replace('T', ' ').replace(/-/g, '-');
          const avatar = isBot ? 'ğŸ‘¨â€âš•ï¸' : 'ğŸ‘¤';

          messageDiv.innerHTML = `
              <div class="message-avatar">${avatar}</div>
              <div class="message-content">
                  <div class="bubble">${formatText(message.content)}</div>
                  <div class="meta">
                      <span>${timeStr}</span>
                      <button type="button" class="delete-btn" data-message-id="${message.id}">åˆ é™¤</button>
                  </div>
              </div>
          `;
          
          // å°†æ–°æ¶ˆæ¯è¿½åŠ åˆ°æœ«å°¾ï¼ˆè€Œä¸æ˜¯æ’å…¥åˆ°"åŠ è½½æ›´å¤š"ä¹‹å‰ï¼‰
          // è¿™æ ·å¯ä»¥ç¡®ä¿æ–°æ¶ˆæ¯æ€»æ˜¯åœ¨æœ€åº•éƒ¨
          chatHistory.appendChild(messageDiv);
          
          // æ»šåŠ¨åˆ°åº•éƒ¨
          scrollToBottom();
      }

      // æ·»åŠ åŠ è½½åŠ¨ç”»
      function addLoadingIndicator() {
          const loadingDiv = document.createElement('div');
          loadingDiv.className = 'message bot loading';
          loadingDiv.id = 'loadingIndicator';
          loadingDiv.innerHTML = `
              <div class="message-avatar">ğŸ‘¨â€âš•ï¸</div>
              <div class="message-content">
                  <div class="bubble">
                      <div class="loading-spinner"></div>
                      <span>å¿ƒç†åŒ»ç”Ÿæ­£åœ¨æ€è€ƒ...</span>
                  </div>
              </div>
          `;
          
          // å°†åŠ è½½åŠ¨ç”»è¿½åŠ åˆ°æœ«å°¾ï¼Œç¡®ä¿å®ƒåœ¨æœ€åº•éƒ¨
          chatHistory.appendChild(loadingDiv);
          
          // æ»šåŠ¨åˆ°åº•éƒ¨
          scrollToBottom();
      }

      // ç§»é™¤åŠ è½½åŠ¨ç”»
      function removeLoadingIndicator() {
          const loading = document.getElementById('loadingIndicator');
          if (loading) {
              loading.remove();
          }
      }

      // å‘é€æ¶ˆæ¯
      messageForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const content = messageInput.value.trim();
          if (!content) return;

          // ä¿å­˜åŸå§‹å†…å®¹
          const originalContent = content;
          
          // ç«‹å³æ¸…ç©ºè¾“å…¥æ¡†ï¼Œç»™ç”¨æˆ·å³æ—¶åé¦ˆ
          messageInput.value = '';
          
          // ç¦ç”¨è¾“å…¥æ¡†å’ŒæŒ‰é’®
          messageInput.disabled = true;
          sendBtn.disabled = true;
          sendBtn.textContent = 'ç­‰å¾…ä¸­...';
          sendBtn.style.opacity = '0.7';

          // ç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆä¸´æ—¶ï¼Œç­‰å¾…æœåŠ¡å™¨å“åº”åä¼šç”¨çœŸå®æ•°æ®æ›¿æ¢ï¼‰
          const now = new Date();
          const tempUserMsg = {
              id: 'temp-' + Date.now(),
              content: originalContent,
              created_at: now.getFullYear() + '-' + 
                         String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(now.getDate()).padStart(2, '0') + ' ' + 
                         String(now.getHours()).padStart(2, '0') + ':' + 
                         String(now.getMinutes()).padStart(2, '0')
          };
          
          // ç«‹å³æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
          addMessage(tempUserMsg, false);
          
          // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼ˆåœ¨ç”¨æˆ·æ¶ˆæ¯ä¹‹åï¼‰
          addLoadingIndicator();

          try {
              // å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨
              const response = await fetch('/api/send_message', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ message: originalContent })
              });

              const data = await response.json();

              if (!response.ok) {
                  throw new Error(data.error || 'å‘é€å¤±è´¥');
              }

              // ç§»é™¤åŠ è½½åŠ¨ç”»
              removeLoadingIndicator();
              
              // ç§»é™¤ä¸´æ—¶ç”¨æˆ·æ¶ˆæ¯
              const tempMsg = chatHistory.querySelector(`[data-message-id="${tempUserMsg.id}"]`);
              if (tempMsg) {
                  tempMsg.remove();
              }

              // æ·»åŠ çœŸå®çš„ç”¨æˆ·æ¶ˆæ¯å’Œæœºå™¨äººå›å¤
              addMessage(data.user_message, false);
              // ç¨å¾®å»¶è¿Ÿæ·»åŠ AIå›å¤ï¼Œç¡®ä¿ç”¨æˆ·æ¶ˆæ¯å…ˆæ˜¾ç¤ºå’Œæ»šåŠ¨
              setTimeout(function() {
                  addMessage(data.bot_message, true);
              }, 50);

          } catch (error) {
              console.error('Error:', error);
              removeLoadingIndicator();
              
              // ç§»é™¤ä¸´æ—¶æ¶ˆæ¯
              const tempMsg = chatHistory.querySelector(`[data-message-id="${tempUserMsg.id}"]`);
              if (tempMsg) {
                  tempMsg.remove();
              }
              
              // æ¢å¤è¾“å…¥æ¡†å†…å®¹
              messageInput.value = originalContent;
              
              alert('å‘é€å¤±è´¥ï¼š' + error.message);
          } finally {
              // æ¢å¤è¾“å…¥æ¡†å’ŒæŒ‰é’®
              messageInput.disabled = false;
              sendBtn.disabled = false;
              sendBtn.textContent = 'å‘é€';
              sendBtn.style.opacity = '1';
              messageInput.focus();
          }
      });

      // åˆ é™¤æ¶ˆæ¯
      chatHistory.addEventListener('click', async function(e) {
          if (e.target.classList.contains('delete-btn')) {
              const messageId = e.target.getAttribute('data-message-id');
              if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                  return;
              }

              try {
                  const response = await fetch(`/delete_message/${messageId}`, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                      }
                  });

                  const data = await response.json();
                  
                  if (response.ok && data.success) {
                      const msgElement = chatHistory.querySelector(`[data-message-id="${messageId}"]`);
                      if (msgElement) {
                          msgElement.remove();
                      }
                  } else {
                      alert('åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                  }
              } catch (error) {
                  console.error('Error:', error);
                  alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
              }
          }
      });

      // åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯ï¼ˆä¿æŒæ»šåŠ¨ä½ç½®ï¼‰
      const loadMoreBtn = document.getElementById('loadMoreBtn');
      if (loadMoreBtn) {
          loadMoreBtn.addEventListener('click', async function(e) {
              e.preventDefault();
              
              // å¦‚æœæ­£åœ¨åŠ è½½ï¼Œç›´æ¥è¿”å›
              if (this.classList.contains('loading')) {
                  return;
              }
              
              const currentLimit = parseInt(this.getAttribute('data-limit'));
              const newLimit = currentLimit + 10;
              
              // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®å’Œç¬¬ä¸€ä¸ªå¯è§æ¶ˆæ¯çš„å¼•ç”¨
              const scrollTop = chatHistory.scrollTop;
              const loadMoreContainer = document.getElementById('loadMoreContainer');
              const firstMessage = loadMoreContainer ? loadMoreContainer.nextElementSibling : chatHistory.querySelector('.message');
              const firstMessageId = firstMessage ? firstMessage.getAttribute('data-message-id') : null;
              const firstMessageOffset = firstMessage ? firstMessage.offsetTop : 0;
              
              // è®¾ç½®åŠ è½½çŠ¶æ€
              const originalText = this.textContent;
              this.textContent = 'åŠ è½½ä¸­...';
              this.classList.add('loading');
              this.style.pointerEvents = 'none';
              
              try {
                  // ä½¿ç”¨ fetch è·å–æ–°å†…å®¹
                  const response = await fetch(`/chat?limit=${newLimit}`);
                  const html = await response.text();
                  
                  // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨æ¥è§£æHTML
                  const tempDiv = document.createElement('div');
                  tempDiv.innerHTML = html;
                  
                  // è·å–æ–°çš„èŠå¤©å†å²å†…å®¹
                  const newChatHistory = tempDiv.querySelector('#chatHistory');
                  if (newChatHistory) {
                      // æ‰¾åˆ°æ–°çš„"åŠ è½½æ›´å¤š"æŒ‰é’®å’Œæ¶ˆæ¯åˆ—è¡¨
                      const newLoadMoreContainer = newChatHistory.querySelector('.load-more');
                      const newMessages = Array.from(newChatHistory.querySelectorAll('.message'));
                      
                      // æ›´æ–°"åŠ è½½æ›´å¤š"æŒ‰é’®
                      if (newLoadMoreContainer && loadMoreContainer) {
                          const newLoadMoreBtn = newLoadMoreContainer.querySelector('a');
                          if (newLoadMoreBtn) {
                              loadMoreBtn.setAttribute('data-limit', newLoadMoreBtn.getAttribute('data-limit'));
                          } else {
                              // å¦‚æœæ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†ï¼Œç§»é™¤"åŠ è½½æ›´å¤š"æŒ‰é’®
                              loadMoreContainer.remove();
                          }
                      } else {
                          // å¦‚æœæ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†ï¼Œç§»é™¤"åŠ è½½æ›´å¤š"æŒ‰é’®
                          if (loadMoreContainer) {
                              loadMoreContainer.remove();
                          }
                      }
                      
                      // æ”¶é›†å½“å‰å·²å­˜åœ¨çš„æ¶ˆæ¯ID
                      const existingIds = new Set();
                      chatHistory.querySelectorAll('.message').forEach(function(msg) {
                          existingIds.add(msg.getAttribute('data-message-id'));
                      });
                      
                      // æ‰¾å‡ºç¬¬ä¸€ä¸ªå·²å­˜åœ¨çš„æ¶ˆæ¯ä½ç½®ï¼ˆä½œä¸ºæ’å…¥å‚è€ƒç‚¹ï¼‰
                      // å¿…é¡»åœ¨loadMoreContainerå­˜åœ¨æ—¶å®šä¹‰
                      const firstExistingMessage = loadMoreContainer ? loadMoreContainer.nextElementSibling : chatHistory.querySelector('.message');
                      
                      // æ”¶é›†æœåŠ¡å™¨è¿”å›çš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆå·²ç»æŒ‰æ­£ç¡®é¡ºåºæ’åˆ—ï¼šæ—§â†’æ–°ï¼‰
                      const allMessageElements = Array.from(newMessages);
                      
                      // æ‰¾å‡ºéœ€è¦æ’å…¥çš„æ–°æ¶ˆæ¯ï¼ˆä¿æŒæœåŠ¡å™¨è¿”å›çš„é¡ºåºï¼‰
                      const messagesToInsert = [];
                      for (let i = 0; i < allMessageElements.length; i++) {
                          const msg = allMessageElements[i];
                          const msgId = msg.getAttribute('data-message-id');
                          if (!existingIds.has(msgId)) {
                              messagesToInsert.push(msg);
                          }
                      }
                      
                      // å¦‚æœ"åŠ è½½æ›´å¤š"æŒ‰é’®å­˜åœ¨ï¼Œåœ¨å®ƒä¹‹åæ’å…¥æ–°æ¶ˆæ¯
                      if (messagesToInsert.length > 0 && loadMoreContainer && loadMoreContainer.parentNode && firstExistingMessage) {
                          // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå·²å­˜åœ¨æ¶ˆæ¯ä½œä¸ºå‚è€ƒç‚¹
                          let insertBefore = firstExistingMessage;
                          
                          // æŒ‰é¡ºåºæ’å…¥æ‰€æœ‰æ–°æ¶ˆæ¯
                          // ç”±äºinsertBeforeä¼šå°†æ–°å…ƒç´ æ’å…¥åˆ°å‚è€ƒèŠ‚ç‚¹ä¹‹å‰ï¼Œ
                          // æˆ‘ä»¬éœ€è¦ä»åå¾€å‰æ’å…¥ï¼Œæˆ–è€…è®©å‚è€ƒç‚¹ä¿æŒå›ºå®š
                          // æ›´å¥½çš„æ–¹æ³•ï¼šä½¿ç”¨appendChildç„¶åè°ƒæ•´é¡ºåºï¼Œæˆ–è€…ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µ
                          const fragment = document.createDocumentFragment();
                          messagesToInsert.forEach(function(msg) {
                              const clonedMsg = msg.cloneNode(true);
                              fragment.appendChild(clonedMsg);
                          });
                          // ä¸€æ¬¡æ€§æ’å…¥æ‰€æœ‰æ¶ˆæ¯åˆ°æ­£ç¡®ä½ç½®
                          loadMoreContainer.parentNode.insertBefore(fragment, insertBefore);
                      } else if (messagesToInsert.length > 0) {
                          // å¦‚æœæ²¡æœ‰"åŠ è½½æ›´å¤š"æŒ‰é’®ï¼Œæ’å…¥åˆ°æœ€å‰é¢
                          const fragment = document.createDocumentFragment();
                          messagesToInsert.forEach(function(msg) {
                              const clonedMsg = msg.cloneNode(true);
                              fragment.appendChild(clonedMsg);
                          });
                          chatHistory.insertBefore(fragment, chatHistory.firstChild);
                      }
                      
                      // æ¢å¤æ»šåŠ¨ä½ç½®ï¼šæ‰¾åˆ°ä¹‹å‰ç¬¬ä¸€ä¸ªå¯è§çš„æ¶ˆæ¯ï¼Œè®¡ç®—ä½ç½®å·®
                      if (firstMessageId) {
                          const targetMessage = chatHistory.querySelector(`[data-message-id="${firstMessageId}"]`);
                          if (targetMessage) {
                              // ç­‰å¾…DOMæ›´æ–°åæ¢å¤æ»šåŠ¨ä½ç½®
                              requestAnimationFrame(function() {
                                  const newOffset = targetMessage.offsetTop;
                                  const offsetDiff = newOffset - firstMessageOffset;
                                  chatHistory.scrollTop = scrollTop + offsetDiff;
                              });
                          }
                      } else {
                          // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›®æ ‡æ¶ˆæ¯ï¼Œå°è¯•ä¿æŒç›¸å¯¹ä½ç½®
                          requestAnimationFrame(function() {
                              chatHistory.scrollTop = scrollTop;
                          });
                      }
                  }
              } catch (error) {
                  console.error('Error loading more messages:', error);
                  alert('åŠ è½½æ›´å¤šæ¶ˆæ¯å¤±è´¥ï¼š' + error.message);
              } finally {
                  // æ¢å¤æŒ‰é’®çŠ¶æ€
                  this.textContent = originalText;
                  this.classList.remove('loading');
                  this.style.pointerEvents = '';
              }
          });
      }

      // è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
      messageInput.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      // å¿«æ·é”®ï¼šEnterå‘é€ï¼ŒShift+Enteræ¢è¡Œ
      messageInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              if (!sendBtn.disabled && messageInput.value.trim()) {
                  messageForm.dispatchEvent(new Event('submit'));
              }
          }
      });

      // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
      window.addEventListener('DOMContentLoaded', function() {
          scrollToBottom();
      });
      
      // ç¡®ä¿åœ¨é¡µé¢å®Œå…¨åŠ è½½åä¹Ÿæ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆå¤„ç†å›¾ç‰‡ç­‰å¼‚æ­¥å†…å®¹ï¼‰
      window.addEventListener('load', function() {
          scrollToBottom();
      });
  </script>
{% endblock %}
